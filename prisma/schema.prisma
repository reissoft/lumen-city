// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ESCOLAS, TURMAS & USUÁRIOS ---

model School {
  id        String   @id @default(uuid())
  name      String
  plan      PlanType @default(STARTER)
  students  Student[]
  teachers  Teacher[]
  classes   Class[]    // Uma escola tem várias turmas
  createdAt DateTime @default(now())
}

model Teacher {
  id            String     @id @default(uuid())
  name          String
  email         String     @unique
  password      String
  isSchoolAdmin Boolean    @default(false)
  schoolId      String
  school        School     @relation(fields: [schoolId], references: [id])
  activities    Activity[]
  classes       Class[]    // Relação muitos-para-muitos com Turmas
  sentMessages     Message[]  @relation("TeacherSentMessages")
  receivedMessages Message[]  @relation("TeacherReceivedMessages")
  notifications    Notification[]
}

model Class {
  id         String     @id @default(uuid())
  name       String
  students   Student[]  // Uma turma tem vários alunos
  activities Activity[]
  createdAt  DateTime   @default(now())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  teachers   Teacher[] // Relação muitos-para-muitos com Professores
}

model Student {
  id              String   @id @default(uuid())
  name            String
  email           String?  @unique
  username        String   @unique
  password        String
  isActive        Boolean  @default(true)
  guardianName    String?
  guardianEmail   String?  
  guardianPhone   String?  
  notes           String?
  schoolId        String
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  classId   String?   // Aluno agora pertence a UMA turma (opcional)
  class     Class?    @relation(fields: [classId], references: [id])

  xp        Int      @default(0)
  level     Int      @default(1)
  resources StudentResources?
  cityData  Json?
  attempts  ActivityAttempt[]
  createdAt DateTime @default(now())
  sentMessages     Message[]  @relation("StudentSentMessages")
  receivedMessages Message[]  @relation("StudentReceivedMessages")
  notifications    Notification[]
}

model StudentResources {
  id        String  @id @default(uuid())
  studentId String  @unique
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  gold      Int     @default(100)
  wood      Int     @default(0)
  energy    Int     @default(0)
  science   Int     @default(0)
}

// --- SISTEMA PEDAGÓGICO ---

model Activity {
  id              String       @id @default(uuid())
  title           String
  description     String?
  type            ActivityType
  payload         Json
  reviewMaterials Json?
  difficulty      Int          @default(1)
  teacherId       String
  teacher         Teacher      @relation(fields: [teacherId], references: [id])
  classes         Class[]
  attempts        ActivityAttempt[]
  createdAt       DateTime     @default(now())
}

model ActivityAttempt {
  id         String   @id @default(uuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  response   Json     
  score      Float
  feedback   String?
  rewarded   Boolean  @default(false)
  createdAt  DateTime @default(now())
}

// --- SISTEMA DE MENSAGENS ---

model Message {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  read      Boolean  @default(false)
  isSystem  Boolean  @default(false)   // indica mensagem gerada pelo sistema

  senderTeacherId   String?
  senderTeacher     Teacher? @relation("TeacherSentMessages", fields: [senderTeacherId], references: [id], onDelete: SetNull)

  senderStudentId   String?
  senderStudent     Student? @relation("StudentSentMessages", fields: [senderStudentId], references: [id], onDelete: SetNull)

  receiverTeacherId String?
  receiverTeacher   Teacher? @relation("TeacherReceivedMessages", fields: [receiverTeacherId], references: [id], onDelete: SetNull)

  receiverStudentId String?
  receiverStudent   Student? @relation("StudentReceivedMessages", fields: [receiverStudentId], references: [id], onDelete: SetNull)
  
  notification      Notification?
}

model Notification {
  id        String   @id @default(uuid())
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  messageId String   @unique
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  recipientTeacherId String?
  recipientTeacher   Teacher? @relation(fields: [recipientTeacherId], references: [id], onDelete: Cascade)

  recipientStudentId String?
  recipientStudent   Student? @relation(fields: [recipientStudentId], references: [id], onDelete: Cascade)
}


// --- ENUMS ---

enum PlanType {
  STARTER
  PRO
  ENTERPRISE
}

enum ActivityType {
  REVISION
  QUIZ
  CONCEPT_MAP
  ESSAY
}
